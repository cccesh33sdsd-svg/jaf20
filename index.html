<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø³Ø§Ø± â€” Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg:#070b11;--bg2:#0c1220;--bg3:#111827;
  --card:#141d2e;--card2:#1a2540;--card3:#1e2d47;
  --accent:#00e5ff;--accent2:#7c3aed;--accent3:#f59e0b;
  --green:#10b981;--red:#ef4444;--pink:#ec4899;
  --text:#e2e8f0;--muted:#64748b;--muted2:#94a3b8;
  --bio:#10b981;--chem:#f59e0b;--phys:#3b82f6;
  --math:#8b5cf6;--lit:#ec4899;--eng:#06b6d4;
  --plan:#f97316;--ai:#a855f7;
  --sidebar:240px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* BG */
.bg-grid{position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,229,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.025) 1px,transparent 1px);
  background-size:44px 44px}
.bg-glow{position:fixed;pointer-events:none;z-index:0;border-radius:50%;filter:blur(130px);opacity:.12}
.g1{width:700px;height:700px;background:var(--accent2);top:-250px;right:-250px}
.g2{width:600px;height:600px;background:var(--accent);bottom:-200px;left:-200px}
.g3{width:400px;height:400px;background:var(--pink);top:50%;left:40%;transform:translate(-50%,-50%);opacity:.06}

/* SIDEBAR */
#sidebar{
  position:fixed;top:0;right:0;width:var(--sidebar);height:100vh;
  background:rgba(12,18,32,.97);border-left:1px solid rgba(0,229,255,.08);
  display:flex;flex-direction:column;z-index:100;
  backdrop-filter:blur(24px);overflow-y:auto;overflow-x:hidden;
  transition:transform .3s cubic-bezier(.4,0,.2,1)
}
.sidebar-logo{
  padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.05);
  display:flex;align-items:center;gap:12px;flex-shrink:0
}
.logo-mark{
  width:42px;height:42px;border-radius:14px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900;color:#000;letter-spacing:-1px
}
.logo-t{font-size:22px;font-weight:900;color:var(--accent);line-height:1}
.logo-s{font-size:10px;color:var(--muted);margin-top:2px}
.nav-sec{padding:14px 10px 4px}
.nav-lbl{font-size:10px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;padding:0 8px 8px}
.nb{
  display:flex;align-items:center;gap:10px;width:100%;
  padding:9px 10px;border:none;background:transparent;
  color:var(--muted);border-radius:10px;cursor:pointer;
  font-family:'Cairo';font-size:13.5px;transition:all .18s;text-align:right;
  position:relative;
}
.nb:hover{background:rgba(255,255,255,.05);color:var(--text)}
.nb.active{background:rgba(0,229,255,.1);color:var(--accent)}
.nb .ico{font-size:17px;min-width:22px;text-align:center}
.sdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.ai-badge{
  margin-right:auto;font-size:9px;padding:2px 6px;border-radius:4px;
  background:rgba(168,85,247,.2);color:var(--ai);border:1px solid rgba(168,85,247,.3)
}
.sidebar-footer{
  margin-top:auto;padding:14px 10px;
  border-top:1px solid rgba(255,255,255,.04);flex-shrink:0
}
.ai-status{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:rgba(0,229,255,.05);border-radius:10px;
  border:1px solid rgba(0,229,255,.1)
}
.pulse{
  width:7px;height:7px;background:var(--green);border-radius:50%;
  box-shadow:0 0 0 0 rgba(16,185,129,.6);
  animation:pulse 2s infinite
}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.5)}70%{box-shadow:0 0 0 8px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}

/* MAIN */
#main{margin-right:var(--sidebar);min-height:100vh;position:relative;z-index:1}

/* TOPBAR */
.topbar{
  height:68px;display:flex;align-items:center;justify-content:space-between;
  padding:0 30px;border-bottom:1px solid rgba(255,255,255,.04);
  background:rgba(7,11,17,.85);backdrop-filter:blur(24px);
  position:sticky;top:0;z-index:50
}
.tb-title{font-size:19px;font-weight:800}
.tb-sub{font-size:12px;color:var(--muted);margin-top:1px}
.user-pill{
  display:flex;align-items:center;gap:10px;background:var(--card2);
  border-radius:50px;padding:5px 16px;cursor:pointer;
  border:1px solid rgba(255,255,255,.06);transition:border-color .2s
}
.user-pill:hover{border-color:var(--accent)}
.uavatar{
  width:30px;height:30px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:800;color:#000
}

/* PAGES */
.page{display:none;padding:28px;animation:fadeUp .3s ease}
.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

/* NAME OVERLAY */
.name-ov{
  position:fixed;inset:0;background:rgba(0,0,0,.88);
  display:flex;align-items:center;justify-content:center;
  z-index:999;backdrop-filter:blur(12px)
}
.name-box{
  background:var(--card);border-radius:24px;padding:44px;
  text-align:center;max-width:420px;width:92%;
  border:1px solid rgba(0,229,255,.2);animation:fadeUp .4s ease
}
.name-box h2{font-size:26px;font-weight:900;margin-bottom:8px}
.name-box p{color:var(--muted);font-size:13px;margin-bottom:26px}
.ni{
  width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,.1);
  color:var(--text);padding:14px 18px;border-radius:12px;
  font-family:'Cairo';font-size:16px;margin-bottom:16px;
  text-align:center;transition:border-color .2s
}
.ni:focus{outline:none;border-color:var(--accent)}

/* BUTTONS */
.btn{
  padding:10px 22px;border-radius:10px;cursor:pointer;
  font-family:'Cairo';font-size:13px;font-weight:700;
  transition:all .18s;border:none;display:inline-flex;
  align-items:center;gap:7px
}
.btn-primary{background:linear-gradient(135deg,var(--accent),#0891b2);color:#000}
.btn-primary:hover{opacity:.88;transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,229,255,.3)}
.btn-sec{background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.1)}
.btn-sec:hover{background:rgba(255,255,255,.1)}
.btn-ai{background:linear-gradient(135deg,var(--ai),#7c3aed);color:#fff}
.btn-ai:hover{opacity:.88;transform:translateY(-1px);box-shadow:0 8px 24px rgba(168,85,247,.4)}
.btn-pdf{background:linear-gradient(135deg,var(--accent3),#d97706);color:#000}
.btn-pdf:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(245,158,11,.4)}
.btn-sm{padding:7px 14px;font-size:12px;border-radius:8px}
.btn-full{width:100%;justify-content:center}

/* INPUTS */
.inp{
  width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,.08);
  color:var(--text);padding:11px 15px;border-radius:10px;
  font-family:'Cairo';font-size:13.5px;transition:border-color .2s
}
.inp:focus{outline:none;border-color:var(--accent)}
.inp::placeholder{color:var(--muted)}
.inp-area{resize:none}
select.inp option{background:var(--bg3)}

/* CARDS */
.card{background:var(--card);border-radius:16px;border:1px solid rgba(255,255,255,.05)}
.card-p{padding:22px}
.card:hover{border-color:rgba(0,229,255,.12)}

/* SECTION TITLE */
.sec-title{
  font-size:17px;font-weight:800;margin-bottom:20px;
  display:flex;align-items:center;gap:10px
}
.sec-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(0,229,255,.25),transparent)}

/* GRID HELPERS */
.g2c{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.g3c{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
.g4c{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}

/* LOADING */
.lbar{height:3px;background:rgba(255,255,255,.05);border-radius:3px;margin:10px 0;overflow:hidden;display:none}
.lbar.show{display:block}
.lfill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));animation:lanim 1.8s ease-in-out infinite;border-radius:3px}
@keyframes lanim{0%{width:0;margin-right:100%}50%{width:60%;margin-right:20%}100%{width:0;margin-right:0}}

/* UPLOAD ZONE */
.upload-zone{
  border:2px dashed rgba(255,255,255,.1);border-radius:16px;
  padding:36px;text-align:center;cursor:pointer;
  transition:all .22s;background:rgba(255,255,255,.015)
}
.upload-zone:hover,.upload-zone.over{border-color:var(--accent);background:rgba(0,229,255,.04)}
.uz-icon{font-size:44px;margin-bottom:12px}
.uz-title{font-size:15px;font-weight:700}
.uz-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* TOAST */
.toast{
  position:fixed;bottom:26px;left:26px;
  background:var(--card2);border:1px solid rgba(0,229,255,.25);
  color:var(--text);padding:11px 20px;border-radius:12px;
  font-size:13px;z-index:2000;
  transform:translateY(80px);opacity:0;transition:all .28s;pointer-events:none
}
.toast.show{transform:none;opacity:1}

/* ========= DASHBOARD ========= */
.welcome{
  background:linear-gradient(120deg,rgba(0,229,255,.1),rgba(124,58,237,.1));
  border:1px solid rgba(0,229,255,.18);border-radius:22px;
  padding:28px 32px;margin-bottom:28px;position:relative;overflow:hidden
}
.welcome::before{
  content:'âœ¦';position:absolute;right:-10px;top:-10px;
  font-size:140px;color:rgba(0,229,255,.04);line-height:1
}
.welcome-name{font-size:30px;font-weight:900}
.welcome-sub{color:var(--muted);font-size:13px;margin-top:4px}
.accent{color:var(--accent)}

.stat-card{
  background:var(--card);border-radius:16px;padding:20px;
  border:1px solid rgba(255,255,255,.05);transition:all .2s
}
.stat-card:hover{border-color:rgba(0,229,255,.25);transform:translateY(-2px)}
.stat-n{font-size:34px;font-weight:900;font-family:'Space Mono'}
.stat-l{font-size:11px;color:var(--muted);margin-top:3px}

.subj-card{
  background:var(--card);border-radius:20px;padding:22px;
  border:1px solid rgba(255,255,255,.05);cursor:pointer;
  transition:all .22s;position:relative;overflow:hidden
}
.subj-card::after{
  content:'';position:absolute;top:0;right:0;
  width:70px;height:70px;border-radius:0 0 0 70px;
  opacity:.12;transition:opacity .2s;
}
.subj-card:hover{transform:translateY(-4px)}
.subj-card:hover::after{opacity:.25}
.subj-card[data-s="bio"]::after{background:var(--bio)}
.subj-card[data-s="chem"]::after{background:var(--chem)}
.subj-card[data-s="phys"]::after{background:var(--phys)}
.subj-card[data-s="math"]::after{background:var(--math)}
.subj-card[data-s="lit"]::after{background:var(--lit)}
.subj-card[data-s="eng"]::after{background:var(--eng)}
.subj-icon{font-size:30px;margin-bottom:10px}
.subj-n{font-size:15px;font-weight:800;margin-bottom:3px}
.subj-d{font-size:11px;color:var(--muted)}
.prog-track{height:3px;background:rgba(255,255,255,.07);border-radius:3px;margin-top:14px}
.prog-bar{height:3px;border-radius:3px}

/* ========= AI CHAT ========= */
.chat-wrap{
  display:flex;flex-direction:column;height:calc(100vh - 180px);
  background:var(--card);border-radius:20px;border:1px solid rgba(168,85,247,.2);
  overflow:hidden
}
.chat-header{
  padding:16px 22px;background:rgba(168,85,247,.08);
  border-bottom:1px solid rgba(168,85,247,.15);
  display:flex;align-items:center;gap:12px;flex-shrink:0
}
.chat-ai-icon{
  width:38px;height:38px;border-radius:12px;
  background:linear-gradient(135deg,var(--ai),#7c3aed);
  display:flex;align-items:center;justify-content:center;font-size:18px
}
.chat-msgs{
  flex:1;overflow-y:auto;padding:20px;
  display:flex;flex-direction:column;gap:14px
}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:var(--card2);border-radius:2px}
.msg{max-width:78%;display:flex;flex-direction:column;gap:4px}
.msg.user{align-self:flex-end;align-items:flex-end}
.msg.ai{align-self:flex-start;align-items:flex-start}
.msg-bubble{
  padding:12px 16px;border-radius:16px;font-size:13.5px;line-height:1.7
}
.msg.user .msg-bubble{
  background:linear-gradient(135deg,rgba(0,229,255,.18),rgba(124,58,237,.18));
  border:1px solid rgba(0,229,255,.2);border-radius:16px 4px 16px 16px
}
.msg.ai .msg-bubble{
  background:var(--card2);border:1px solid rgba(255,255,255,.07);
  border-radius:4px 16px 16px 16px
}
.msg-bubble h3{color:var(--accent);margin-bottom:6px;font-size:14px}
.msg-bubble ul{padding-right:18px;margin:6px 0}
.msg-bubble li{margin-bottom:4px;color:var(--muted2)}
.msg-bubble strong{color:var(--accent3)}
.msg-bubble code{
  background:rgba(0,229,255,.1);padding:1px 6px;border-radius:4px;
  font-family:'Space Mono';font-size:12px;color:var(--accent)
}
.msg-time{font-size:10px;color:var(--muted)}
.chat-input-row{
  padding:16px 20px;border-top:1px solid rgba(255,255,255,.05);
  background:rgba(0,0,0,.2);display:flex;gap:10px;align-items:flex-end;flex-shrink:0
}
.chat-file-btn{
  width:38px;height:38px;border-radius:10px;
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;transition:all .2s
}
.chat-file-btn:hover{background:rgba(168,85,247,.15);border-color:var(--ai)}
.chat-tinp{
  flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,.08);
  color:var(--text);padding:10px 14px;border-radius:12px;
  font-family:'Cairo';font-size:13.5px;resize:none;
  min-height:40px;max-height:120px;transition:border-color .2s
}
.chat-tinp:focus{outline:none;border-color:var(--ai)}
.chat-send{
  width:40px;height:40px;border-radius:10px;flex-shrink:0;
  background:linear-gradient(135deg,var(--ai),#7c3aed);border:none;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:18px;transition:all .2s
}
.chat-send:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(168,85,247,.4)}
.chat-attach-preview{
  padding:0 20px 10px;display:flex;gap:8px;flex-wrap:wrap
}
.attach-chip{
  background:rgba(168,85,247,.15);border:1px solid rgba(168,85,247,.3);
  border-radius:6px;padding:4px 10px;font-size:11px;color:var(--ai);
  display:flex;align-items:center;gap:6px
}
.attach-chip span{cursor:pointer;color:var(--muted)}
.attach-chip span:hover{color:var(--red)}
.typing-dot{
  display:flex;gap:4px;align-items:center;padding:14px 16px;
  background:var(--card2);border-radius:16px;width:fit-content
}
.typing-dot span{
  width:7px;height:7px;background:var(--muted);border-radius:50%;
  animation:tdot 1.2s infinite
}
.typing-dot span:nth-child(2){animation-delay:.2s}
.typing-dot span:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,80%,100%{transform:scale(.9);opacity:.4}40%{transform:scale(1.2);opacity:1}}

/* ========= DIAGRAM PLANNER ========= */
.diagram-layout{display:grid;grid-template-columns:320px 1fr;gap:20px;height:calc(100vh - 180px)}
.diag-panel{
  background:var(--card);border-radius:18px;
  border:1px solid rgba(255,255,255,.06);
  display:flex;flex-direction:column;overflow:hidden
}
.diag-panel-header{
  padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.05);
  font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px
}
.diag-panel-body{padding:16px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
.diag-canvas-wrap{
  background:var(--card);border-radius:18px;
  border:1px solid rgba(255,255,255,.06);
  display:flex;flex-direction:column;overflow:hidden
}
.diag-toolbar{
  padding:12px 18px;border-bottom:1px solid rgba(255,255,255,.05);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap
}
.tool-btn{
  padding:6px 14px;border-radius:8px;font-size:12px;
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
  color:var(--muted);cursor:pointer;font-family:'Cairo';
  transition:all .18s;display:flex;align-items:center;gap:5px
}
.tool-btn:hover{background:rgba(255,255,255,.1);color:var(--text)}
.tool-btn.active{background:rgba(0,229,255,.12);border-color:var(--accent);color:var(--accent)}
#diagramCanvas{
  flex:1;background:var(--bg3);position:relative;overflow:auto;
  min-height:400px;cursor:default
}
.diag-node{
  position:absolute;min-width:120px;padding:12px 18px;
  border-radius:12px;border:2px solid;cursor:grab;
  text-align:center;font-size:13px;font-weight:600;
  user-select:none;transition:box-shadow .2s;
  display:flex;flex-direction:column;gap:4px
}
.diag-node:active{cursor:grabbing}
.diag-node:hover{box-shadow:0 6px 20px rgba(0,0,0,.4)}
.diag-node .nd-sub{font-size:10px;opacity:.7;font-weight:400}
.diag-connection{
  position:absolute;pointer-events:none;
  stroke-width:2;fill:none
}
svg.connections-layer{
  position:absolute;top:0;left:0;width:100%;height:100%;
  pointer-events:none;overflow:visible
}
.node-color-bio{background:rgba(16,185,129,.15);border-color:var(--bio);color:var(--bio)}
.node-color-chem{background:rgba(245,158,11,.15);border-color:var(--chem);color:var(--chem)}
.node-color-phys{background:rgba(59,130,246,.15);border-color:var(--phys);color:var(--phys)}
.node-color-math{background:rgba(139,92,246,.15);border-color:var(--math);color:var(--math)}
.node-color-gen{background:rgba(0,229,255,.12);border-color:var(--accent);color:var(--accent)}

/* ========= SUBJECT PAGE ========= */
.subj-page-header{
  display:flex;align-items:center;gap:14px;margin-bottom:24px;flex-wrap:wrap
}
.subj-badge{
  padding:6px 16px;border-radius:20px;font-size:13px;font-weight:700;
  border:1px solid
}
.ai-result{
  background:var(--card);border-radius:18px;
  border:1px solid rgba(0,229,255,.14);padding:24px;
  margin-top:18px;display:none
}
.ai-result.show{display:block;animation:fadeUp .3s ease}
.rtabs{display:flex;gap:7px;margin-bottom:18px;flex-wrap:wrap}
.rtab{
  padding:6px 16px;border-radius:18px;font-size:12.5px;
  border:1px solid rgba(255,255,255,.1);background:transparent;
  color:var(--muted);cursor:pointer;font-family:'Cairo';transition:all .18s
}
.rtab.active{background:rgba(0,229,255,.12);border-color:var(--accent);color:var(--accent)}
.rc{font-size:13.5px;line-height:1.85;color:var(--text);display:none}
.rc.show{display:block;animation:fadeUp .25s ease}
.rc h3{color:var(--accent);margin-bottom:8px;font-size:15px}
.rc h4{color:var(--accent3);margin-bottom:6px;font-size:13px}
.rc ul,.rc ol{padding-right:20px;margin:8px 0}
.rc li{margin-bottom:5px;color:var(--muted2)}
.rc table{width:100%;border-collapse:collapse;margin:12px 0;font-size:12px}
.rc th{background:rgba(0,229,255,.1);padding:8px 12px;text-align:right;color:var(--accent)}
.rc td{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.05)}
.rc .highlight{background:rgba(245,158,11,.1);border-right:3px solid var(--accent3);padding:10px 14px;border-radius:0 8px 8px 0;margin:10px 0}
.video-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.vc{
  background:var(--card2);border-radius:12px;padding:12px;
  border:1px solid rgba(255,255,255,.06);display:flex;gap:10px;
  align-items:center;cursor:pointer;transition:border-color .18s
}
.vc:hover{border-color:rgba(255,0,0,.4)}
.vthumb{
  width:58px;height:42px;background:#0f0f0f;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;flex-shrink:0;border:1px solid rgba(255,0,0,.25);color:#ff4444
}
.v-title{font-size:11.5px;font-weight:700;margin-bottom:2px;line-height:1.4}
.v-ch{font-size:10px;color:var(--muted)}

/* ========= ENGLISH / TRANSLATION ========= */
.trans-hero{
  background:linear-gradient(135deg,rgba(6,182,212,.1),rgba(8,145,178,.05));
  border:1px solid rgba(6,182,212,.2);border-radius:22px;
  padding:32px;margin-bottom:24px;text-align:center
}
.trans-hero h2{font-size:26px;font-weight:900;color:var(--eng);margin-bottom:6px}
.trans-hero p{color:var(--muted);font-size:13px}
.trans-input-row{display:flex;gap:12px;margin-bottom:18px;align-items:flex-end}
.trans-result-box{
  background:var(--card);border-radius:20px;padding:28px;
  border:1px solid rgba(6,182,212,.18);display:none
}
.trans-result-box.show{display:block;animation:fadeUp .3s ease}
.original-text{
  font-family:'Space Mono';font-size:18px;font-weight:700;
  color:var(--eng);line-height:1.5;margin-bottom:6px
}
.trans-arabic{font-size:20px;font-weight:700;line-height:1.7;margin:12px 0}
.pron-box{
  background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);
  border-radius:12px;padding:14px 18px;font-family:'Space Mono';
  font-size:14px;color:var(--accent3);line-height:1.7;margin:14px 0
}
.pron-label{font-size:10px;letter-spacing:2px;color:var(--accent3);text-transform:uppercase;margin-bottom:6px}
.speak-btn{
  background:linear-gradient(135deg,var(--eng),#0284c7);
  border:none;padding:10px 24px;border-radius:50px;color:#fff;
  font-family:'Cairo';font-weight:700;cursor:pointer;font-size:14px;
  display:flex;align-items:center;gap:8px;transition:all .2s
}
.speak-btn:hover{transform:scale(1.03);box-shadow:0 8px 24px rgba(6,182,212,.4)}
.speak-btn.playing{background:linear-gradient(135deg,#f97316,#dc2626);animation:pulse-speak .5s ease infinite alternate}
@keyframes pulse-speak{from{transform:scale(1)}to{transform:scale(1.04)}}
.word-row{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
.word-chip{
  background:var(--card2);border-radius:10px;padding:9px 14px;
  border:1px solid rgba(255,255,255,.07);cursor:pointer;
  transition:all .18s
}
.word-chip:hover{border-color:var(--eng);background:rgba(6,182,212,.1)}
.wc-en{font-size:14px;font-weight:800;color:var(--eng)}
.wc-ar{font-size:11px;color:var(--muted);margin-top:1px}
.wc-pron{font-size:10px;color:var(--accent3);font-family:'Space Mono';margin-top:2px}
.mem-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
.mem-c{
  background:var(--card2);border-radius:12px;padding:14px;
  border:1px solid rgba(255,255,255,.06);text-align:center
}
.mc-q{font-size:15px;font-weight:800;color:var(--eng);margin-bottom:6px}
.mc-a{font-size:12px;color:var(--muted);display:none}
.mc-btn{
  background:rgba(6,182,212,.1);border:1px solid var(--eng);
  color:var(--eng);padding:4px 12px;border-radius:6px;
  font-size:11px;cursor:pointer;font-family:'Cairo';
  margin-top:8px;display:inline-block;transition:all .18s
}

/* ========= FLASHCARDS ========= */
.fc-grid{display:grid;grid-template-columns:340px 1fr;gap:22px}
.fc-list{display:flex;flex-direction:column;gap:10px;max-height:calc(100vh - 280px);overflow-y:auto}
.fc-list::-webkit-scrollbar{width:3px}
.fc-list::-webkit-scrollbar-thumb{background:var(--card2);border-radius:2px}
.fcard{
  background:var(--card2);border-radius:14px;padding:15px;
  border:1px solid rgba(255,255,255,.06);cursor:pointer;
  transition:all .18s;position:relative
}
.fcard:hover{border-color:rgba(0,229,255,.25)}
.fcard.flipped{background:rgba(0,229,255,.05);border-color:rgba(0,229,255,.2)}
.fc-q{font-size:14px;font-weight:700}
.fc-a{font-size:12.5px;color:var(--muted2);margin-top:8px;padding-top:10px;border-top:1px solid rgba(255,255,255,.06);display:none}
.fcard.flipped .fc-a{display:block}
.fcard-del{
  position:absolute;top:10px;left:10px;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;font-size:12px;transition:color .18s;padding:2px 5px
}
.fcard-del:hover{color:var(--red)}

/* ========= PLANNING ========= */
.task-item{
  display:flex;align-items:center;gap:10px;
  padding:11px 14px;background:var(--bg3);border-radius:10px;
  border:1px solid rgba(255,255,255,.05);transition:all .18s
}
.task-item:hover{border-color:rgba(255,255,255,.1)}
.task-item.done{opacity:.5}
.task-item.done .ti-title{text-decoration:line-through}
.tchk{
  width:20px;height:20px;border-radius:6px;
  border:2px solid rgba(255,255,255,.2);cursor:pointer;
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
  font-size:11px;transition:all .18s
}
.tchk.done{background:var(--green);border-color:var(--green);color:#fff}
.ti-title{flex:1;font-size:13px}
.ti-meta{font-size:10px;color:var(--muted)}
.ti-del{color:var(--muted);cursor:pointer;font-size:12px;padding:3px 6px;transition:color .18s}
.ti-del:hover{color:var(--red)}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--card2);border-radius:2px}

/* MOBILE */
@media(max-width:900px){
  #sidebar{transform:translateX(100%)}
  #sidebar.open{transform:none}
  #main{margin-right:0}
  .g4c{grid-template-columns:1fr 1fr}
  .g3c{grid-template-columns:1fr 1fr}
  .g2c{grid-template-columns:1fr}
  .fc-grid{grid-template-columns:1fr}
  .diagram-layout{grid-template-columns:1fr}
  .diag-canvas-wrap{display:none}
  .mem-row{grid-template-columns:1fr 1fr}
  .video-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="bg-grid"></div>
<div class="bg-glow g1"></div>
<div class="bg-glow g2"></div>
<div class="bg-glow g3"></div>

<!-- NAME OVERLAY -->
<div class="name-ov" id="nameOv">
  <div class="name-box">
    <div style="font-size:52px;margin-bottom:14px;filter:drop-shadow(0 0 20px rgba(0,229,255,.4))">âœ¦</div>
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ <span class="accent">Ù…Ø³Ø§Ø±</span></h2>
    <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„Ù…</p>
    <input class="ni" id="ni" placeholder="Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="30" onkeydown="if(event.key==='Enter')saveName()">
    <button class="btn btn-primary btn-full" onclick="saveName()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† âœ¦</button>
  </div>
</div>

<!-- SIDEBAR -->
<nav id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">Ù…</div>
    <div><div class="logo-t">Ù…Ø³Ø§Ø±</div><div class="logo-s">Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div></div>
  </div>

  <div class="nav-sec">
    <div class="nav-lbl">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <button class="nb active" onclick="nav('dashboard',this)"><span class="ico">âŠ</span> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    <button class="nb" onclick="nav('ai',this)"><span class="ico">â—†</span> Gemini AI <span class="ai-badge">NEW</span></button>
    <button class="nb" onclick="nav('diagram',this)"><span class="ico">â—ˆ</span> Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</button>
    <button class="nb" onclick="nav('planning',this)"><span class="ico">â˜</span> Ø§Ù„ØªØ®Ø·ÙŠØ·</button>
    <button class="nb" onclick="nav('flashcards',this)"><span class="ico">â—»</span> Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­ÙØ¸</button>
  </div>

  <div class="nav-sec">
    <div class="nav-lbl">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
    <button class="nb" onclick="openSubject('bio',this)"><span class="sdot" style="background:var(--bio)"></span> Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</button>
    <button class="nb" onclick="openSubject('chem',this)"><span class="sdot" style="background:var(--chem)"></span> Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</button>
    <button class="nb" onclick="openSubject('phys',this)"><span class="sdot" style="background:var(--phys)"></span> Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</button>
    <button class="nb" onclick="openSubject('math',this)"><span class="sdot" style="background:var(--math)"></span> Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button>
    <button class="nb" onclick="openSubject('lit',this)"><span class="sdot" style="background:var(--lit)"></span> Ø§Ù„Ø£Ø¯Ø¨</button>
    <button class="nb" onclick="openSubject('eng',this)"><span class="sdot" style="background:var(--eng)"></span> Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</button>
  </div>

  <div class="sidebar-footer">
    <div class="ai-status">
      <div style="font-size:16px">â—†</div>
      <div style="flex:1">
        <div style="font-size:11px;color:var(--ai);font-weight:700">Gemini AI</div>
        <div style="font-size:10px;color:var(--muted)">Flash 1.5 â€” Ù…ØªØµÙ„</div>
      </div>
      <div class="pulse"></div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div id="main">
  <div class="topbar">
    <div>
      <div class="tb-title" id="tbTitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div class="tb-sub" id="tbSub">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ù…Ø³Ø§Ø±</div>
    </div>
    <div class="user-pill">
      <div class="uavatar" id="uav">ØŸ</div>
      <span id="uname">Ø·Ø§Ù„Ø¨</span>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="pg-dashboard">
    <div class="welcome">
      <div class="welcome-name">Ø£Ù‡Ù„Ø§Ù‹ØŒ <span class="accent" id="wname">Ø·Ø§Ù„Ø¨</span> ğŸ‘‹</div>
      <div class="welcome-sub">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ø±Ø§Ø³Ø©ØŸ Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø£Ùˆ ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
    </div>
    <div class="g4c" style="margin-bottom:28px">
      <div class="stat-card"><div class="stat-n accent" id="st-cards">0</div><div class="stat-l">Ø¨Ø·Ø§Ù‚Ø© Ø­ÙØ¸</div></div>
      <div class="stat-card"><div class="stat-n" style="color:var(--plan)" id="st-tasks">0</div><div class="stat-l">Ù…Ù‡Ù…Ø© Ø¯Ø±Ø§Ø³ÙŠØ©</div></div>
      <div class="stat-card"><div class="stat-n" style="color:var(--green)" id="st-done">0</div><div class="stat-l">Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø©</div></div>
      <div class="stat-card"><div class="stat-n" style="color:var(--math)" id="st-diags">0</div><div class="stat-l">Ù…Ø®Ø·Ø· Ù…Ø­ÙÙˆØ¸</div></div>
    </div>
    <div class="sec-title">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
    <div class="g3c">
      <div class="subj-card" data-s="bio" onclick="openSubject('bio',null)">
        <div class="subj-icon">ğŸ§¬</div><div class="subj-n" style="color:var(--bio)">Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</div>
        <div class="subj-d">Ø®Ù„Ø§ÙŠØ§ØŒ ÙˆØ±Ø§Ø«Ø©ØŒ ØªØ´Ø±ÙŠØ­</div>
        <div class="prog-track"><div class="prog-bar" style="background:var(--bio);width:45%"></div></div>
      </div>
      <div class="subj-card" data-s="chem" onclick="openSubject('chem',null)">
        <div class="subj-icon">âš—ï¸</div><div class="subj-n" style="color:var(--chem)">Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</div>
        <div class="subj-d">Ø¹Ø¶ÙˆÙŠØŒ ØºÙŠØ± Ø¹Ø¶ÙˆÙŠØŒ Ù…Ø¹Ø§Ø¯Ù„Ø§Øª</div>
        <div class="prog-track"><div class="prog-bar" style="background:var(--chem);width:30%"></div></div>
      </div>
      <div class="subj-card" data-s="phys" onclick="openSubject('phys',null)">
        <div class="subj-icon">âš¡</div><div class="subj-n" style="color:var(--phys)">Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</div>
        <div class="subj-d">Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…ÙˆØ¬Ø§Øª</div>
        <div class="prog-track"><div class="prog-bar" style="background:var(--phys);width:60%"></div></div>
      </div>
      <div class="subj-card" data-s="math" onclick="openSubject('math',null)">
        <div class="subj-icon">âˆ‘</div><div class="subj-n" style="color:var(--math)">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
        <div class="subj-d">Ø¬Ø¨Ø±ØŒ ØªÙØ§Ø¶Ù„ØŒ Ø¥Ø­ØµØ§Ø¡</div>
        <div class="prog-track"><div class="prog-bar" style="background:var(--math);width:70%"></div></div>
      </div>
      <div class="subj-card" data-s="lit" onclick="openSubject('lit',null)">
        <div class="subj-icon">ğŸ“œ</div><div class="subj-n" style="color:var(--lit)">Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠ</div>
        <div class="subj-d">Ø´Ø¹Ø±ØŒ Ù†Ø«Ø±ØŒ Ø¨Ù„Ø§ØºØ©</div>
        <div class="prog-track"><div class="prog-bar" style="background:var(--lit);width:20%"></div></div>
      </div>
      <div class="subj-card" data-s="eng" onclick="openSubject('eng',null)">
        <div class="subj-icon">ğŸ”¤</div><div class="subj-n" style="color:var(--eng)">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</div>
        <div class="subj-d">ØªØ±Ø¬Ù…Ø©ØŒ Ù†Ø·Ù‚ØŒ Ù‚ÙˆØ§Ø¹Ø¯</div>
        <div class="prog-track"><div class="prog-bar" style="background:var(--eng);width:50%"></div></div>
      </div>
    </div>
  </div>

  <!-- GEMINI AI CHAT -->
  <div class="page" id="pg-ai">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px">
      <div class="sec-title" style="margin-bottom:0">â—† Gemini AI â€” Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sec btn-sm" onclick="clearChat()">ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        <button class="btn btn-pdf btn-sm" onclick="exportChatPDF()">â¬‡ ØªØµØ¯ÙŠØ± PDF</button>
      </div>
    </div>
    <div class="chat-wrap">
      <div class="chat-header">
        <div class="chat-ai-icon">â—†</div>
        <div>
          <div style="font-size:14px;font-weight:700;color:var(--ai)">Gemini Flash 1.5</div>
          <div style="font-size:11px;color:var(--muted)">Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø°ÙƒÙŠ â€” ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</div>
        </div>
        <div class="pulse" style="margin-right:auto"></div>
      </div>
      <div class="chat-msgs" id="chatMsgs">
        <div class="msg ai">
          <div class="msg-bubble">
            Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ <strong>Gemini</strong> Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø°ÙƒÙŠ ğŸ“<br>
            ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:<br>
            â€¢ Ø´Ø±Ø­ Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø¯Ø±Ø§Ø³ÙŠ<br>
            â€¢ ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ±<br>
            â€¢ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø®Ø·Ø·Ø§Øª ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø­ÙØ¸<br>
            â€¢ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ<br><br>
            ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸš€
          </div>
          <div class="msg-time">Ø§Ù„Ø¢Ù†</div>
        </div>
      </div>
      <div class="chat-attach-preview" id="chatAttachPrev"></div>
      <div class="lbar" id="chatLoading"><div class="lfill"></div></div>
      <div class="chat-input-row">
        <input type="file" id="chatFile" style="display:none" accept="image/*,.pdf,.txt" multiple onchange="handleChatFile(this)">
        <div class="chat-file-btn" onclick="document.getElementById('chatFile').click()" title="Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø£Ùˆ ØµÙˆØ±Ø©">ğŸ“</div>
        <textarea class="chat-tinp" id="chatInp" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡... Ø£Ùˆ Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Ù‹ ÙˆØµÙˆØ±Ø©" rows="1"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"
          oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
        <button class="chat-send" onclick="sendChat()" title="Ø¥Ø±Ø³Ø§Ù„">â¤</button>
      </div>
    </div>
  </div>

  <!-- DIAGRAM PLANNER -->
  <div class="page" id="pg-diagram">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px">
      <div class="sec-title" style="margin-bottom:0">â—ˆ Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-sec btn-sm" onclick="clearDiagram()">ğŸ—‘ Ù…Ø³Ø­</button>
        <button class="btn btn-pdf btn-sm" onclick="exportDiagramPDF()">â¬‡ PDF</button>
        <button class="btn btn-ai btn-sm" onclick="aiGenerateDiagram()">â—† ØªÙˆÙ„ÙŠØ¯ AI</button>
      </div>
    </div>
    <div class="diagram-layout">
      <!-- PANEL -->
      <div class="diag-panel">
        <div class="diag-panel-header">â—ˆ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯Ø©</div>
        <div class="diag-panel-body">
          <input class="inp" id="nodeText" placeholder="Ù†Øµ Ø§Ù„Ø¹Ù‚Ø¯Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
          <input class="inp" id="nodeSubtext" placeholder="Ù†Øµ ÙØ±Ø¹ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-top:8px">
          <div style="margin-top:8px">
            <div class="form-label" style="font-size:11px;color:var(--muted);margin-bottom:6px">Ø§Ù„Ù„ÙˆÙ†</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <div onclick="setNodeColor('gen')" class="color-pick" style="width:28px;height:28px;background:rgba(0,229,255,.15);border:2px solid var(--accent);border-radius:6px;cursor:pointer" title="Ø¹Ø§Ù…"></div>
              <div onclick="setNodeColor('bio')" class="color-pick" style="width:28px;height:28px;background:rgba(16,185,129,.15);border:2px solid var(--bio);border-radius:6px;cursor:pointer" title="Ø£Ø­ÙŠØ§Ø¡"></div>
              <div onclick="setNodeColor('chem')" class="color-pick" style="width:28px;height:28px;background:rgba(245,158,11,.15);border:2px solid var(--chem);border-radius:6px;cursor:pointer" title="ÙƒÙŠÙ…ÙŠØ§Ø¡"></div>
              <div onclick="setNodeColor('phys')" class="color-pick" style="width:28px;height:28px;background:rgba(59,130,246,.15);border:2px solid var(--phys);border-radius:6px;cursor:pointer" title="ÙÙŠØ²ÙŠØ§Ø¡"></div>
              <div onclick="setNodeColor('math')" class="color-pick" style="width:28px;height:28px;background:rgba(139,92,246,.15);border:2px solid var(--math);border-radius:6px;cursor:pointer" title="Ø±ÙŠØ§Ø¶ÙŠØ§Øª"></div>
            </div>
          </div>
          <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="addNode()">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯Ø©</button>

          <div style="margin-top:14px;background:var(--bg3);border-radius:12px;padding:14px;border:1px solid rgba(168,85,247,.15)">
            <div style="font-size:12px;color:var(--ai);font-weight:700;margin-bottom:10px">â—† ØªÙˆÙ„ÙŠØ¯ Ù…Ø®Ø·Ø· Ø¨Ø§Ù„Ù€ AI</div>
            <input class="inp" id="diagramTopic" placeholder="Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ù…Ø«Ø§Ù„ â€” Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø­ÙŠÙˆØ§Ù†ÙŠØ©">
            <div class="lbar" id="diagramLoading" style="margin:8px 0"><div class="lfill"></div></div>
            <button class="btn btn-ai btn-full" style="margin-top:8px" onclick="aiGenerateDiagram()">âœ¦ ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          </div>

          <div style="margin-top:14px">
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ø®Ø·Ø·</div>
            <div class="upload-zone" onclick="document.getElementById('diagFile').click()" style="padding:20px">
              <input type="file" id="diagFile" style="display:none" accept="image/*" onchange="analyzeDiagramFile(this)">
              <div style="font-size:26px">ğŸ“·</div>
              <div style="font-size:12px;margin-top:6px">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ø®Ø·Ø·</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (<span id="savedDiagCount">0</span>)</div>
            <div id="savedDiagList" style="display:flex;flex-direction:column;gap:6px"></div>
          </div>
        </div>
      </div>
      <!-- CANVAS -->
      <div class="diag-canvas-wrap">
        <div class="diag-toolbar">
          <span style="font-size:12px;color:var(--muted)">Ø£Ø¯ÙˆØ§Øª:</span>
          <button class="tool-btn active" id="toolMove" onclick="setTool('move',this)">â†– ØªØ­Ø±ÙŠÙƒ</button>
          <button class="tool-btn" id="toolConnect" onclick="setTool('connect',this)">âŸ¶ Ø±Ø¨Ø·</button>
          <button class="tool-btn" id="toolDelete" onclick="setTool('delete',this)">âœ• Ø­Ø°Ù</button>
          <span style="font-size:11px;color:var(--muted);margin-right:auto" id="toolHint">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù‚Ø¯ Ù„ØªØ­Ø±ÙŠÙƒÙ‡Ø§</span>
          <button class="tool-btn" onclick="saveDiagram()">ğŸ’¾ Ø­ÙØ¸</button>
        </div>
        <div id="diagramCanvas" style="position:relative;overflow:hidden">
          <svg class="connections-layer" id="connSvg"></svg>
          <div id="nodesContainer" style="position:absolute;inset:0"></div>
          <div id="emptyDiag" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;color:var(--muted);pointer-events:none">
            <div style="font-size:56px">â—ˆ</div>
            <div style="font-size:14px">Ø£Ø¶Ù Ø¹Ù‚Ø¯Ø© Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù…Ù† AI ØªÙˆÙ„ÙŠØ¯ Ù…Ø®Ø·Ø·</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUBJECT PAGE -->
  <div class="page" id="pg-subject">
    <div class="subj-page-header">
      <button class="btn btn-sec btn-sm" onclick="nav('dashboard',null)">â† Ø±Ø¬ÙˆØ¹</button>
      <div>
        <div style="font-size:20px;font-weight:900" id="sp-name">Ø§Ù„Ù…Ø§Ø¯Ø©</div>
        <div style="font-size:12px;color:var(--muted)">Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Ù‹ Ù„ØªØ­Ù„ÙŠÙ„Ù‡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
      </div>
      <button class="btn btn-pdf btn-sm" onclick="exportSubjectPDF()" style="margin-right:auto">â¬‡ PDF</button>
    </div>

    <div class="upload-zone" id="sp-upload" onclick="document.getElementById('sp-file').click()">
      <input type="file" id="sp-file" style="display:none" accept="image/*,.pdf,.txt,.doc,.docx" onchange="analyzeSubjectFile(this)">
      <div class="uz-icon">ğŸ“‚</div>
      <div class="uz-title">Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Ù‹ Ø£Ùˆ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø§Ø¯Ø©</div>
      <div class="uz-sub">PNG Â· JPG Â· PDF Â· TXT â€” ÙŠØ­Ù„Ù„Ù‡Ø§ Gemini ÙÙˆØ±Ø§Ù‹</div>
    </div>

    <div class="lbar" id="sp-loading"><div class="lfill"></div></div>

    <div class="ai-result" id="sp-result">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:16px">
        <div style="font-size:15px;font-weight:800;display:flex;align-items:center;gap:8px">â—† Ù†ØªØ§Ø¦Ø¬ Gemini AI</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sec btn-sm" onclick="saveSubjToCards()">ğŸ’¾ Ø¨Ø·Ø§Ù‚Ø§Øª</button>
          <button class="btn btn-pdf btn-sm" onclick="exportSubjectPDF()">â¬‡ PDF</button>
        </div>
      </div>
      <div class="rtabs">
        <button class="rtab active" onclick="showTab('s',this)">Ø§Ù„Ù…Ù„Ø®Øµ</button>
        <button class="rtab" onclick="showTab('e',this)">Ø§Ù„Ø´Ø±Ø­</button>
        <button class="rtab" onclick="showTab('m',this)">ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø­ÙØ¸</button>
        <button class="rtab" onclick="showTab('v',this)">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
        <button class="rtab" onclick="showTab('q',this)">Ø£Ø³Ø¦Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
      </div>
      <div class="rc show" id="tab-s"></div>
      <div class="rc" id="tab-e"></div>
      <div class="rc" id="tab-m"></div>
      <div class="rc" id="tab-v"></div>
      <div class="rc" id="tab-q"></div>
    </div>

    <!-- ENGLISH TRANSLATION SECTION (shown for eng subject) -->
    <div id="eng-section" style="display:none;margin-top:24px">
      <div class="sec-title">âŸ ØªØ±Ø¬Ù…Ø© Ø°ÙƒÙŠØ© + Ø§Ù„Ù†Ø·Ù‚</div>
      <div class="trans-hero">
        <h2>English Smart Translator</h2>
        <p>Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹ â€” Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„Ù†Ø·Ù‚ Ø§Ù„Ù…ÙƒØªÙˆØ¨ ÙˆØ§Ù„ØµÙˆØªÙŠ</p>
      </div>
      <div class="trans-input-row">
        <textarea class="inp inp-area" id="transInp" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù‡Ù†Ø§... Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø©/Ù…Ù„Ù" style="flex:1;margin-bottom:0"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-sec" onclick="document.getElementById('transFile').click()">ğŸ“· Ø±ÙØ¹</button>
          <button class="btn btn-primary" onclick="doTranslate()">ØªØ±Ø¬Ù… âœ¦</button>
          <input type="file" id="transFile" style="display:none" accept="image/*,.pdf,.txt" onchange="handleTransFile(this)">
        </div>
      </div>
      <div class="lbar" id="transLoading"><div class="lfill"></div></div>
      <div class="trans-result-box" id="transResult">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:16px">
          <div>
            <div style="font-size:10px;color:var(--muted);letter-spacing:2px;margin-bottom:4px">ORIGINAL</div>
            <div class="original-text" id="tr-orig"></div>
          </div>
          <button class="speak-btn" id="speakMain" onclick="speakNow(document.getElementById('tr-orig').textContent)">
            ğŸ”Š Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ø·Ù‚
          </button>
        </div>
        <div style="background:var(--bg3);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,.06);margin-bottom:12px">
          <div style="font-size:10px;color:var(--muted);letter-spacing:2px;margin-bottom:6px">Ø§Ù„ØªØ±Ø¬Ù…Ø©</div>
          <div id="tr-ar" style="font-size:19px;font-weight:700;line-height:1.7"></div>
        </div>
        <div class="pron-box">
          <div class="pron-label">Ø§Ù„Ù†Ø·Ù‚ / Pronunciation</div>
          <div id="tr-pron"></div>
        </div>
        <div style="font-size:13px;font-weight:700;margin:16px 0 10px;color:var(--eng)">ğŸ“š ÙƒÙ„Ù…Ø© Ø¨ÙƒÙ„Ù…Ø©</div>
        <div class="word-row" id="tr-words"></div>
        <div style="font-size:13px;font-weight:700;margin:16px 0 10px;color:var(--eng)">ğŸ§  Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­ÙØ¸</div>
        <div class="mem-row" id="tr-mem"></div>
        <div style="display:flex;gap:10px;margin-top:18px;flex-wrap:wrap">
          <button class="btn btn-pdf" onclick="exportTransPDF()">â¬‡ ØªØµØ¯ÙŠØ± PDF</button>
          <button class="btn btn-sec" onclick="saveTransCards()">ğŸ’¾ Ø­ÙØ¸ ÙƒØ¨Ø·Ø§Ù‚Ø§Øª</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FLASHCARDS -->
  <div class="page" id="pg-flashcards">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <div class="sec-title" style="margin-bottom:0">â—» Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­ÙØ¸</div>
      <button class="btn btn-pdf btn-sm" onclick="exportCardsPDF()">â¬‡ PDF</button>
    </div>
    <div class="fc-grid">
      <div>
        <div class="card card-p" style="margin-bottom:14px">
          <div style="font-size:13px;font-weight:800;margin-bottom:12px">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
          <textarea class="inp inp-area" id="fc-q" rows="2" placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø§Ù„Ù…ØµØ·Ù„Ø­..." style="margin-bottom:8px"></textarea>
          <textarea class="inp inp-area" id="fc-a" rows="2" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø£Ùˆ Ø§Ù„ØªØ¹Ø±ÙŠÙ..." style="margin-bottom:8px"></textarea>
          <select class="inp" id="fc-sub" style="margin-bottom:8px">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
            <option value="bio">ğŸ§¬ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</option>
            <option value="chem">âš—ï¸ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
            <option value="phys">âš¡ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</option>
            <option value="math">âˆ‘ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
            <option value="lit">ğŸ“œ Ø§Ù„Ø£Ø¯Ø¨</option>
            <option value="eng">ğŸ”¤ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
          </select>
          <button class="btn btn-primary btn-full" onclick="addCard()">+ Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div class="card card-p">
          <div style="font-size:12px;color:var(--ai);font-weight:700;margin-bottom:10px">â—† AI â€” ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
          <input class="inp" id="aiTopic" placeholder="Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹... Ù…Ø«Ø§Ù„: Ø§Ù„Ø§Ù†Ù‚Ø³Ø§Ù… Ø§Ù„Ø®Ù„ÙˆÙŠ" style="margin-bottom:8px">
          <div class="lbar" id="aiCardLoading"><div class="lfill"></div></div>
          <button class="btn btn-ai btn-full" onclick="genAICards()">âœ¦ ØªÙˆÙ„ÙŠØ¯ Ø¨Ø·Ø§Ù‚Ø§Øª</button>
        </div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Â· <span id="cardCount">0</span> Ø¨Ø·Ø§Ù‚Ø©</div>
        <div class="fc-list" id="fcList"></div>
        <div id="fcEmpty" style="text-align:center;padding:50px;color:var(--muted)">
          <div style="font-size:44px;margin-bottom:12px">â—»</div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø¹Ø¯
        </div>
      </div>
    </div>
  </div>

  <!-- PLANNING -->
  <div class="page" id="pg-planning">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <div class="sec-title" style="margin-bottom:0">â˜ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div>
      <button class="btn btn-pdf btn-sm" onclick="exportPlanPDF()">â¬‡ PDF</button>
    </div>
    <div class="g2c">
      <div class="card card-p">
        <div style="font-size:14px;font-weight:800;margin-bottom:14px">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</div>
        <input class="inp" id="t-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©" style="margin-bottom:8px">
        <select class="inp" id="t-sub" style="margin-bottom:8px">
          <option value="bio">ğŸ§¬ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</option><option value="chem">âš—ï¸ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
          <option value="phys">âš¡ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</option><option value="math">âˆ‘ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
          <option value="lit">ğŸ“œ Ø§Ù„Ø£Ø¯Ø¨</option><option value="eng">ğŸ”¤ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
        </select>
        <input class="inp" type="date" id="t-date" style="margin-bottom:8px">
        <select class="inp" id="t-pri" style="margin-bottom:10px">
          <option value="high">ğŸ”´ Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</option>
          <option value="med" selected>ğŸŸ¡ Ø£ÙˆÙ„ÙˆÙŠØ© Ù…ØªÙˆØ³Ø·Ø©</option>
          <option value="low">ğŸŸ¢ Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©</option>
        </select>
        <button class="btn btn-primary btn-full" onclick="addTask()">+ Ø¥Ø¶Ø§ÙØ©</button>
        <div style="margin-top:16px;background:var(--bg3);border-radius:12px;padding:14px;border:1px solid rgba(249,115,22,.15)">
          <div style="font-size:12px;color:var(--plan);font-weight:700;margin-bottom:8px">â—† Ø®Ø·Ø© AI Ø°ÙƒÙŠØ©</div>
          <input class="inp" id="planGoal" placeholder="Ù‡Ø¯ÙÙƒ: Ù…Ø«Ø§Ù„ â€” Ø§Ø¬ØªÙŠØ§Ø² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹" style="margin-bottom:8px">
          <div class="lbar" id="planLoading"><div class="lfill"></div></div>
          <button class="btn btn-ai btn-full" onclick="genAIPlan()">âœ¦ ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø©</button>
        </div>
      </div>
      <div class="card card-p">
        <div style="font-size:14px;font-weight:800;margin-bottom:14px">Ø§Ù„Ù…Ù‡Ø§Ù… (<span id="taskCount">0</span>)</div>
        <div id="taskList" style="display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 340px);overflow-y:auto"></div>
        <div id="taskEmpty" style="text-align:center;padding:50px;color:var(--muted)">
          <div style="font-size:44px;margin-bottom:12px">â˜</div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯
        </div>
      </div>
    </div>
  </div>

</div><!-- /main -->

<div class="toast" id="toast">âœ“ ØªÙ…</div>

<script>
// ======================== CONFIG ========================
const GKEY = 'AIzaSyAWk_8uV2jWinOEF7-d_-0CjTJwjGdblvw';
const GURL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GKEY}`;

// ======================== STATE ========================
let cards = JSON.parse(localStorage.getItem('m_cards')||'[]');
let tasks = JSON.parse(localStorage.getItem('m_tasks')||'[]');
let diagrams = JSON.parse(localStorage.getItem('m_diags')||'[]');
let chatHistory = [];
let chatAttachments = []; // {name, b64, type}
let currentSubj = 'bio';
let currentSubjData = null;
let currentTransData = null;
let diagramNodes = []; // {id,x,y,text,sub,color}
let diagramConns = []; // {from,to}
let selectedTool = 'move';
let connecting = null; // nodeId
let nodeColor = 'gen';
let dragging = null;
let dragOffX = 0, dragOffY = 0;
let voices = [];

const SC = {
  bio:{name:'ğŸ§¬ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡',color:'var(--bio)',en:'Biology'},
  chem:{name:'âš—ï¸ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡',color:'var(--chem)',en:'Chemistry'},
  phys:{name:'âš¡ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡',color:'var(--phys)',en:'Physics'},
  math:{name:'âˆ‘ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',color:'var(--math)',en:'Mathematics'},
  lit:{name:'ğŸ“œ Ø§Ù„Ø£Ø¯Ø¨',color:'var(--lit)',en:'Arabic Literature'},
  eng:{name:'ğŸ”¤ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',color:'var(--eng)',en:'English'}
};

// ======================== INIT ========================
window.onload = ()=>{
  const name = localStorage.getItem('m_name');
  if(name){ document.getElementById('nameOv').style.display='none'; setName(name); }
  document.getElementById('t-date').valueAsDate = new Date();
  if('speechSynthesis' in window) window.speechSynthesis.onvoiceschanged = ()=>{ voices = speechSynthesis.getVoices(); };
  renderAll();
};

function saveName(){
  const n = document.getElementById('ni').value.trim();
  if(!n){ toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  localStorage.setItem('m_name',n);
  document.getElementById('nameOv').style.display='none';
  setName(n);
}
function setName(n){
  document.getElementById('wname').textContent = n;
  document.getElementById('uname').textContent = n;
  document.getElementById('uav').textContent = n[0].toUpperCase();
}
function renderAll(){ renderCards(); renderTasks(); updateStats(); renderSavedDiags(); }

// ======================== NAVIGATION ========================
function nav(id, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('pg-'+id).classList.add('active');
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const titles = {
    dashboard:['Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…','Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©'],
    ai:['Gemini AI','Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ'],
    diagram:['Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©','Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª'],
    subject:[SC[currentSubj]?.name,'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø§Ø¯Ø©'],
    flashcards:['Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­ÙØ¸','Ø£Ù†Ø´Ø¦ ÙˆØ±Ø§Ø¬Ø¹'],
    planning:['Ø§Ù„ØªØ®Ø·ÙŠØ·','Ù†Ø¸Ù‘Ù… Ù…Ù‡Ø§Ù…Ùƒ']
  };
  const t = titles[id]||['',''];
  document.getElementById('tbTitle').textContent = t[0];
  document.getElementById('tbSub').textContent = t[1];
  if(id==='dashboard') updateStats();
}

function openSubject(s, btn){
  currentSubj = s;
  document.getElementById('sp-name').textContent = SC[s].name;
  document.getElementById('sp-result').classList.remove('show');
  // show/hide eng section
  document.getElementById('eng-section').style.display = s==='eng' ? 'block' : 'none';
  nav('subject', btn);
}

// ======================== GEMINI API ========================
async function gemini(prompt, b64=null, mime='image/jpeg'){
  const parts = [];
  if(b64) parts.push({inline_data:{mime_type:mime, data:b64}});
  parts.push({text: prompt});
  const r = await fetch(GURL,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({contents:[{parts}]})
  });
  if(!r.ok) throw new Error('Gemini API error '+r.status);
  const d = await r.json();
  return d.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

async function geminiMulti(prompt, attachments=[]){
  const parts = [];
  for(const a of attachments){
    if(a.b64) parts.push({inline_data:{mime_type: a.type.startsWith('image') ? a.type : 'image/jpeg', data:a.b64}});
  }
  parts.push({text: prompt});
  const r = await fetch(GURL,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({contents:[{parts}]})
  });
  if(!r.ok) throw new Error('API error');
  const d = await r.json();
  return d.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

function f2b64(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result.split(',')[1]); r.readAsDataURL(file); }); }
function f2text(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsText(file); }); }

// ======================== AI CHAT ========================
async function sendChat(){
  const inp = document.getElementById('chatInp');
  const msg = inp.value.trim();
  if(!msg && !chatAttachments.length) return;
  const attaches = [...chatAttachments];
  chatAttachments = [];
  document.getElementById('chatAttachPrev').innerHTML = '';
  inp.value = ''; inp.style.height = 'auto';

  appendMsg('user', msg || 'ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª', attaches);
  chatHistory.push({role:'user', text: msg, attaches});

  const loading = document.getElementById('chatLoading');
  loading.classList.add('show');
  appendTyping();

  try {
    const sys = `Ø£Ù†Øª GeminiØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø°ÙƒÙŠ ÙˆÙˆØ¯ÙˆØ¯ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ÙÙ‡Ù… ÙˆØ§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªÙ„Ø®ÙŠØµ. Ø§Ø¬Ø¹Ù„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ù†Ø¸Ù…Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… HTML (h3, ul, li, strong, table, code). Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… markdown.`;
    const history = chatHistory.slice(-6).map(h=>`${h.role==='user'?'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…':'AI'}: ${h.text}`).join('\n');
    const prompt = sys + '\n\nØ³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:\n' + history;
    let resp;
    if(attaches.length){
      resp = await geminiMulti(prompt + '\n\nØ±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + msg, attaches);
    } else {
      resp = await gemini(prompt + '\n\nØ±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + msg);
    }
    removeTyping();
    appendMsg('ai', resp);
    chatHistory.push({role:'ai', text: resp});
  } catch(e){
    removeTyping();
    appendMsg('ai', '<span style="color:var(--red)">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Gemini. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.</span>');
  } finally { loading.classList.remove('show'); }
}

function appendMsg(role, text, attaches=[]){
  const msgs = document.getElementById('chatMsgs');
  const now = new Date().toLocaleTimeString('ar',{hour:'2-digit',minute:'2-digit'});
  const attHtml = attaches.length ? attaches.map(a=>`<span style="font-size:11px;background:rgba(168,85,247,.15);padding:2px 8px;border-radius:4px;color:var(--ai)">ğŸ“ ${a.name}</span>`).join(' ') : '';
  const d = document.createElement('div');
  d.className = `msg ${role}`;
  d.innerHTML = `<div class="msg-bubble">${attHtml}${attHtml?' ':''}${text}</div><div class="msg-time">${now}</div>`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

function appendTyping(){
  const msgs = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'msg ai'; d.id = 'typing-indicator';
  d.innerHTML = '<div class="typing-dot"><span></span><span></span><span></span></div>';
  msgs.appendChild(d); msgs.scrollTop = msgs.scrollHeight;
}
function removeTyping(){ const t = document.getElementById('typing-indicator'); if(t) t.remove(); }

async function handleChatFile(input){
  for(const file of input.files){
    const isImg = file.type.startsWith('image/');
    const b64 = isImg ? await f2b64(file) : null;
    chatAttachments.push({name:file.name, b64, type:file.type});
    const prev = document.getElementById('chatAttachPrev');
    const chip = document.createElement('div');
    chip.className = 'attach-chip';
    chip.innerHTML = `${isImg?'ğŸ–¼':'ğŸ“„'} ${file.name} <span onclick="this.parentElement.remove(); chatAttachments = chatAttachments.filter(a=>a.name!=='${file.name}')">âœ•</span>`;
    prev.appendChild(chip);
  }
  input.value = '';
}

function clearChat(){
  chatHistory = [];
  const msgs = document.getElementById('chatMsgs');
  msgs.innerHTML = `<div class="msg ai"><div class="msg-bubble">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØªÙ…Øª Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ âœ¦</div></div>`;
}

// ======================== SUBJECT ANALYSIS ========================
async function analyzeSubjectFile(input){
  const file = input.files[0]; if(!file) return;
  const loading = document.getElementById('sp-loading');
  loading.classList.add('show');
  try{
    const isImg = file.type.startsWith('image/');
    let b64=null, txt='';
    if(isImg) b64 = await f2b64(file);
    else txt = (await f2text(file)).substring(0,4000);
    const subj = SC[currentSubj].name;
    const en = SC[currentSubj].en;
    const content = b64 ? 'Ø§Ù†Ø¸Ø± Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©' : txt;

    const p1 = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ ${subj}. Ø­Ù„Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ£Ø¹Ø·Ù†ÙŠ Ù…Ù„Ø®ØµØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…Ù†Ø¸Ù…Ø§Ù‹ Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆÙÙ‚Ø±Ø§Øª ÙˆØ¬Ø¯Ø§ÙˆÙ„ Ø¥Ù† ÙˆØ¬Ø¯. Ø§Ø³ØªØ®Ø¯Ù… HTML (h3, ul, li, strong, table). Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${content}`;
    const p2 = `Ø£Ù†Øª Ù…Ø¯Ø±Ø³ Ù„Ù…Ø§Ø¯Ø© ${subj}. Ø§Ø´Ø±Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¨Ø³ÙŠØ· Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© Ø­ÙŠØ§ØªÙŠØ©. Ø§Ø³ØªØ®Ø¯Ù… HTML. Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${content}`;
    const p3 = `Ù„Ù…Ø§Ø¯Ø© ${subj}ØŒ Ø£Ù†Ø´Ø¦: 1) Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ù‚Ø§Ø±Ù†Ø© HTMLØŒ 2) Ù‚ÙˆØ§Ø¦Ù… Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø±ÙŠØ¹ØŒ 3) Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø°ÙƒÙŠØ© Ù„Ù„Ø­ÙØ¸ØŒ 4) Ù†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ© Ù…ÙÙ„ÙˆÙ‘Ù†Ø©. Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${content}`;
    const p4 = `Ø§Ù‚ØªØ±Ø­ 4 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨ Ù„Ø´Ø±Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ù…Ø§Ø¯Ø© ${en} Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON ÙÙ‚Ø·: {"videos":[{"title":"Ø¹Ù†ÙˆØ§Ù†","channel":"Ù‚Ù†Ø§Ø©","desc":"ÙˆØµÙ Ù‚ØµÙŠØ±","q":"ÙƒÙ„Ù…Ø§Øª Ø¨Ø­Ø«"}]}. Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${content}`;
    const p5 = `Ø£Ù†Ø´Ø¦ 5 Ø£Ø³Ø¦Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© (ØµØ­/Ø®Ø·Ø£ØŒ Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯ØŒ Ù…Ù‚Ø§Ù„ÙŠ) Ø¨Ø¥Ø¬Ø§Ø¨Ø§ØªÙ‡Ø§ Ù„Ù…Ø§Ø¯Ø© ${subj}. Ø§Ø³ØªØ®Ø¯Ù… HTML. Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${content}`;

    const [s,e,m,vr,q] = await Promise.all([
      gemini(p1, b64), gemini(p2, b64), gemini(p3, b64), gemini(p4, b64), gemini(p5, b64)
    ]);

    currentSubjData = {s,e,m,q,subj};
    document.getElementById('tab-s').innerHTML = s;
    document.getElementById('tab-e').innerHTML = e;
    document.getElementById('tab-m').innerHTML = m;
    document.getElementById('tab-q').innerHTML = q;

    let vHtml = '<div class="video-grid">';
    try{
      const vd = JSON.parse(vr.replace(/```json|```/g,'').trim());
      vd.videos.forEach(v=>{
        const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(v.q||v.title)}`;
        vHtml += `<div class="vc" onclick="window.open('${url}','_blank')"><div class="vthumb">â–¶</div><div><div class="v-title">${v.title}</div><div class="v-ch">${v.channel} â€” ${v.desc}</div></div></div>`;
      });
    } catch { vHtml += `<div style="color:var(--muted)">Ø§Ø¨Ø­Ø« Ø¹Ù„Ù‰ ÙŠÙˆØªÙŠÙˆØ¨ Ø¹Ù† Ø´Ø±Ø­ ${SC[currentSubj].name}</div>`; }
    vHtml += '</div>';
    document.getElementById('tab-v').innerHTML = vHtml;

    document.getElementById('sp-result').classList.add('show');
    toast('ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ“');
  } catch(e){ toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); console.error(e); }
  finally{ loading.classList.remove('show'); input.value=''; }
}

function showTab(id, btn){
  ['s','e','m','v','q'].forEach(t=>{ document.getElementById('tab-'+t).classList.remove('show'); });
  document.getElementById('tab-'+id).classList.add('show');
  document.querySelectorAll('.rtab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function saveSubjToCards(){
  if(!currentSubjData) return;
  const subj = Object.keys(SC).find(k=>SC[k].name===currentSubjData.subj)||'';
  addCard(`Ù…Ù„Ø®Øµ: ${currentSubjData.subj}`, 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹', subj);
}

// ======================== TRANSLATION ========================
async function handleTransFile(input){
  const file = input.files[0]; if(!file) return;
  const isImg = file.type.startsWith('image/');
  loading('transLoading',true);
  try{
    if(isImg){
      const b64 = await f2b64(file);
      const txt = await gemini('Ø§Ø³ØªØ®Ø±Ø¬ ÙƒÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©. Ø£Ø¹Ø·Ù†ÙŠ Ø§Ù„Ù†Øµ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ù„ÙŠÙ‚.', b64);
      document.getElementById('transInp').value = txt;
    } else {
      document.getElementById('transInp').value = (await f2text(file)).substring(0,2000);
    }
    doTranslate();
  } finally { loading('transLoading',false); input.value=''; }
}

async function doTranslate(){
  const text = document.getElementById('transInp').value.trim();
  if(!text){ toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  loading('transLoading',true);
  try{
    const prompt = `Ø§Ù„Ø¬Ù…Ù„Ø©: "${text}"
Ø£Ø¹Ø·Ù†ÙŠ JSON ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø®Ø§Ø±Ø¬Ù‡:
{"translation":"Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©","pronunciation":"Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù…Ù„Ø© ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø£Ø­Ø±Ù Ù„Ø§ØªÙŠÙ†ÙŠØ© Ù…Ø«Ù„: heh-low, haow arr yoo","words":[{"en":"word","ar":"ÙƒÙ„Ù…Ø©","pron":"Ù†Ø·Ù‚","type":"noun/verb/adj"}],"memory":[{"q":"ÙƒÙ„Ù…Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©","a":"ØªØ±Ø¬Ù…Ø© + Ù…Ø«Ø§Ù„"},{"q":"ÙƒÙ„Ù…Ø©","a":"ØªØ±Ø¬Ù…Ø© + Ù…Ø«Ø§Ù„"},{"q":"ÙƒÙ„Ù…Ø©","a":"ØªØ±Ø¬Ù…Ø© + Ù…Ø«Ø§Ù„"}]}`;
    const resp = await gemini(prompt);
    const data = JSON.parse(resp.replace(/```json|```/g,'').trim());
    currentTransData = {text, ...data};

    document.getElementById('tr-orig').textContent = text;
    document.getElementById('tr-ar').textContent = data.translation;
    document.getElementById('tr-pron').textContent = data.pronunciation;

    const wDiv = document.getElementById('tr-words');
    wDiv.innerHTML = (data.words||[]).slice(0,20).map(w=>`
      <div class="word-chip" onclick="speakNow('${w.en.replace(/'/g,"\\'")}')">
        <div class="wc-en">${w.en}</div>
        <div class="wc-ar">${w.ar}</div>
        <div class="wc-pron">/${w.pron}/</div>
      </div>`).join('');

    const mDiv = document.getElementById('tr-mem');
    mDiv.innerHTML = (data.memory||[]).map(m=>{
      const id='m'+Math.random().toString(36).substr(2,6);
      return `<div class="mem-c">
        <div class="mc-q">${m.q}</div>
        <div class="mc-a" id="${id}">${m.a}</div>
        <div class="mc-btn" onclick="document.getElementById('${id}').style.display='block';this.remove()">Ø§Ø¸Ù‡Ø±</div>
      </div>`;
    }).join('');

    document.getElementById('transResult').classList.add('show');
  } catch(e){ toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©'); console.error(e); }
  finally{ loading('transLoading',false); }
}

function speakNow(text){
  if(!('speechSynthesis' in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US'; u.rate = 0.82; u.pitch = 1;
  const engVoice = voices.find(v=>v.lang.startsWith('en'));
  if(engVoice) u.voice = engVoice;
  const btn = document.getElementById('speakMain');
  if(btn){ btn.classList.add('playing'); u.onend=()=>btn.classList.remove('playing'); }
  speechSynthesis.speak(u);
}

function saveTransCards(){
  if(!currentTransData) return;
  (currentTransData.words||[]).slice(0,6).forEach(w=>{
    addCard(w.en, `${w.ar} | /${w.pron}/`, 'eng');
  });
}

function exportTransPDF(){
  if(!currentTransData){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ±Ø¬Ù…Ø©'); return; }
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18); doc.text('Massar - Translation',105,18,{align:'center'});
  doc.setFontSize(12);
  doc.text('Original: '+currentTransData.text,14,36);
  const lines = doc.splitTextToSize('Translation: '+currentTransData.translation, 180);
  doc.text(lines,14,48);
  doc.text('Pronunciation: '+(currentTransData.pronunciation||''),14,48+lines.length*7);
  doc.save('massar-translation.pdf');
  toast('ØªÙ… ØªØµØ¯ÙŠØ± PDF âœ“');
}

// ======================== DIAGRAMS ========================
function setTool(t, btn){
  selectedTool = t;
  connecting = null;
  document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const hints = {move:'Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù‚Ø¯ Ù„ØªØ­Ø±ÙŠÙƒÙ‡Ø§',connect:'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯Ø© Ø«Ù… Ø¹Ù‚Ø¯Ø© Ø£Ø®Ø±Ù‰ Ù„Ø±Ø¨Ø·Ù‡Ù…Ø§',delete:'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯Ø© Ø£Ùˆ Ø®Ø· Ù„Ù„Ø­Ø°Ù'};
  document.getElementById('toolHint').textContent = hints[t];
  document.getElementById('nodesContainer').querySelectorAll('.diag-node').forEach(n=>{
    n.style.cursor = t==='move' ? 'grab' : t==='delete' ? 'crosshair' : 'pointer';
  });
}

function setNodeColor(c){ nodeColor = c; document.querySelectorAll('.color-pick').forEach(p=>p.style.outline='none'); event?.target?.style && (event.target.style.outline='2px solid #fff'); }

function addNode(txt=null, sub=null, x=null, y=null, c=null){
  const text = txt || document.getElementById('nodeText').value.trim();
  if(!text){ toast('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø¹Ù‚Ø¯Ø©'); return; }
  const id = 'n'+Date.now();
  const canvas = document.getElementById('diagramCanvas');
  const node = {
    id, text, sub: sub || document.getElementById('nodeSubtext').value.trim(),
    color: c || nodeColor,
    x: x !== null ? x : 60 + Math.random()*300,
    y: y !== null ? y : 60 + Math.random()*200
  };
  diagramNodes.push(node);
  renderNodeEl(node);
  document.getElementById('nodeText').value = '';
  document.getElementById('nodeSubtext').value = '';
  document.getElementById('emptyDiag').style.display = 'none';
  updateConnections();
}

function renderNodeEl(node){
  const el = document.createElement('div');
  el.className = `diag-node node-color-${node.color}`;
  el.id = node.id;
  el.style.left = node.x+'px';
  el.style.top = node.y+'px';
  el.innerHTML = node.text + (node.sub ? `<div class="nd-sub">${node.sub}</div>` : '');
  el.addEventListener('mousedown', onNodeMouseDown);
  el.addEventListener('click', onNodeClick);
  document.getElementById('nodesContainer').appendChild(el);
}

function onNodeMouseDown(e){
  if(selectedTool !== 'move') return;
  e.preventDefault();
  dragging = e.currentTarget.id;
  const el = document.getElementById(dragging);
  const canvas = document.getElementById('diagramCanvas');
  const cr = canvas.getBoundingClientRect();
  dragOffX = e.clientX - cr.left - parseInt(el.style.left);
  dragOffY = e.clientY - cr.top - parseInt(el.style.top);
  el.style.cursor = 'grabbing';
}

document.addEventListener('mousemove', e=>{
  if(!dragging) return;
  const canvas = document.getElementById('diagramCanvas');
  const cr = canvas.getBoundingClientRect();
  const el = document.getElementById(dragging);
  if(!el) return;
  const nx = e.clientX - cr.left - dragOffX;
  const ny = e.clientY - cr.top - dragOffY;
  el.style.left = Math.max(0,nx)+'px';
  el.style.top = Math.max(0,ny)+'px';
  const nd = diagramNodes.find(n=>n.id===dragging);
  if(nd){ nd.x = Math.max(0,nx); nd.y = Math.max(0,ny); }
  updateConnections();
});

document.addEventListener('mouseup', ()=>{
  if(dragging){ const el=document.getElementById(dragging); if(el) el.style.cursor='grab'; dragging=null; }
});

function onNodeClick(e){
  const id = e.currentTarget.id;
  if(selectedTool === 'delete'){
    diagramNodes = diagramNodes.filter(n=>n.id!==id);
    diagramConns = diagramConns.filter(c=>c.from!==id&&c.to!==id);
    document.getElementById(id)?.remove();
    updateConnections();
    if(!diagramNodes.length) document.getElementById('emptyDiag').style.display='flex';
  } else if(selectedTool === 'connect'){
    if(!connecting){ connecting=id; e.currentTarget.style.boxShadow='0 0 0 3px white'; }
    else if(connecting !== id){
      const exists = diagramConns.find(c=>(c.from===connecting&&c.to===id)||(c.from===id&&c.to===connecting));
      if(!exists) diagramConns.push({from:connecting, to:id});
      document.getElementById(connecting)?.style.removeProperty('box-shadow');
      connecting = null;
      updateConnections();
    }
  }
}

function updateConnections(){
  const svg = document.getElementById('connSvg');
  svg.innerHTML = '';
  for(const conn of diagramConns){
    const a = document.getElementById(conn.from);
    const b = document.getElementById(conn.to);
    if(!a||!b) continue;
    const ax = parseInt(a.style.left)+a.offsetWidth/2;
    const ay = parseInt(a.style.top)+a.offsetHeight/2;
    const bx = parseInt(b.style.left)+b.offsetWidth/2;
    const by = parseInt(b.style.top)+b.offsetHeight/2;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',ax); line.setAttribute('y1',ay);
    line.setAttribute('x2',bx); line.setAttribute('y2',by);
    line.setAttribute('stroke','rgba(0,229,255,0.35)'); line.setAttribute('stroke-width','2');
    line.setAttribute('stroke-dasharray','6,3');
    svg.appendChild(line);
    // arrow
    const angle = Math.atan2(by-ay, bx-ax);
    const arrX = bx - 12*Math.cos(angle), arrY = by - 12*Math.sin(angle);
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    const pts = [
      [arrX+8*Math.cos(angle), arrY+8*Math.sin(angle)],
      [arrX-5*Math.cos(angle-0.5), arrY-5*Math.sin(angle-0.5)],
      [arrX-5*Math.cos(angle+0.5), arrY-5*Math.sin(angle+0.5)]
    ].map(p=>p.join(',')).join(' ');
    poly.setAttribute('points',pts); poly.setAttribute('fill','rgba(0,229,255,0.5)');
    svg.appendChild(poly);
  }
}

async function aiGenerateDiagram(){
  const topic = document.getElementById('diagramTopic').value.trim();
  if(!topic){ toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  loading('diagramLoading',true);
  try{
    const resp = await gemini(`Ø£Ù†Ø´Ø¦ Ù…Ø®Ø·Ø· ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹: "${topic}"
Ø£Ø¹Ø·Ù†ÙŠ JSON ÙÙ‚Ø·:
{"nodes":[{"id":"n1","text":"Ø¹Ù†ÙˆØ§Ù† Ø±Ø¦ÙŠØ³ÙŠ","sub":"ØªÙØµÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ","color":"gen","x":300,"y":50},...],"connections":[{"from":"n1","to":"n2"},...]}
Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©: gen, bio, chem, phys, math
Ø£Ù†Ø´Ø¦ 5-8 Ø¹Ù‚Ø¯ Ù…ØªØ±Ø§Ø¨Ø·Ø© Ù…Ù†Ø·Ù‚ÙŠØ§Ù‹. JSON ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ.`);
    const data = JSON.parse(resp.replace(/```json|```/g,'').trim());
    clearDiagram(true);
    data.nodes.forEach(n=>{ diagramNodes.push(n); renderNodeEl(n); });
    diagramConns = data.connections||[];
    updateConnections();
    document.getElementById('emptyDiag').style.display='none';
    toast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${data.nodes.length} Ø¹Ù‚Ø¯Ø© âœ“`);
  } catch(e){ toast('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø®Ø·Ø·'); console.error(e); }
  finally{ loading('diagramLoading',false); }
}

async function analyzeDiagramFile(input){
  const file = input.files[0]; if(!file) return;
  loading('diagramLoading',true);
  try{
    const b64 = await f2b64(file);
    const resp = await gemini(`Ø§Ù†Ø¸Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ­Ù„Ù„ Ø§Ù„Ù…Ø®Ø·Ø· Ø£Ùˆ Ø§Ù„Ø±Ø³Ù… ÙÙŠÙ‡Ø§. Ø£Ù†Ø´Ø¦ Ø¹Ù‚Ø¯ Ù…Ø´Ø§Ø¨Ù‡Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON:
{"nodes":[{"id":"n1","text":"Ù†Øµ","sub":"ÙØ±Ø¹ÙŠ","color":"gen","x":200,"y":100}...],"connections":[{"from":"n1","to":"n2"}]}
ÙÙ‚Ø· JSON.`, b64);
    const data = JSON.parse(resp.replace(/```json|```/g,'').trim());
    clearDiagram(true);
    data.nodes.forEach(n=>{ diagramNodes.push(n); renderNodeEl(n); });
    diagramConns = data.connections||[];
    updateConnections();
    document.getElementById('emptyDiag').style.display='none';
    toast('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© âœ“');
  } catch(e){ toast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'); }
  finally{ loading('diagramLoading',false); input.value=''; }
}

function clearDiagram(silent=false){
  diagramNodes=[]; diagramConns=[];
  document.getElementById('nodesContainer').innerHTML='';
  document.getElementById('connSvg').innerHTML='';
  document.getElementById('emptyDiag').style.display='flex';
  if(!silent) toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø®Ø·Ø·');
}

function saveDiagram(){
  if(!diagramNodes.length){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø¯ Ù„Ù„Ø­ÙØ¸'); return; }
  const d = {id:Date.now(), nodes:[...diagramNodes], conns:[...diagramConns], date: new Date().toLocaleDateString('ar')};
  diagrams.unshift(d);
  localStorage.setItem('m_diags', JSON.stringify(diagrams));
  updateStats(); renderSavedDiags();
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø·Ø· âœ“');
}

function loadDiagram(id){
  const d = diagrams.find(x=>x.id===id); if(!d) return;
  clearDiagram(true);
  diagramNodes = [...d.nodes];
  diagramConns = [...d.conns];
  diagramNodes.forEach(n=>renderNodeEl(n));
  updateConnections();
  document.getElementById('emptyDiag').style.display='none';
  toast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·');
}

function renderSavedDiags(){
  const list = document.getElementById('savedDiagList');
  document.getElementById('savedDiagCount').textContent = diagrams.length;
  if(!diagrams.length){ list.innerHTML=''; return; }
  list.innerHTML = diagrams.slice(0,5).map(d=>`
    <div style="display:flex;align-items:center;gap:8px;background:var(--bg3);border-radius:8px;padding:8px 10px;border:1px solid rgba(255,255,255,.05)">
      <div style="flex:1">
        <div style="font-size:12px;font-weight:600">${d.nodes[0]?.text||'Ù…Ø®Ø·Ø·'}</div>
        <div style="font-size:10px;color:var(--muted)">${d.nodes.length} Ø¹Ù‚Ø¯ Â· ${d.date}</div>
      </div>
      <button onclick="loadDiagram(${d.id})" style="font-size:11px;background:rgba(0,229,255,.1);border:1px solid rgba(0,229,255,.2);color:var(--accent);padding:3px 8px;border-radius:6px;cursor:pointer;font-family:'Cairo'">ØªØ­Ù…ÙŠÙ„</button>
      <span onclick="diagrams=diagrams.filter(x=>x.id!==${d.id});localStorage.setItem('m_diags',JSON.stringify(diagrams));renderSavedDiags();updateStats()" style="color:var(--muted);cursor:pointer;font-size:12px">âœ•</span>
    </div>`).join('');
}

function exportDiagramPDF(){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  doc.setFontSize(18); doc.text('Massar - Diagram',148,18,{align:'center'});
  diagramNodes.forEach((n,i)=>{
    doc.setFontSize(11);
    doc.text(`â€¢ ${n.text}${n.sub?' â€” '+n.sub:''}`, 14, 36+i*10);
  });
  doc.save('massar-diagram.pdf');
  toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ“');
}

// ======================== FLASHCARDS ========================
function addCard(q=null, a=null, s=null){
  const question = q||document.getElementById('fc-q').value.trim();
  const answer = a||document.getElementById('fc-a').value.trim();
  const subject = s!==null ? s : document.getElementById('fc-sub').value;
  if(!question||!answer){ toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø©'); return; }
  cards.push({id:Date.now(), q:question, a:answer, s:subject});
  localStorage.setItem('m_cards', JSON.stringify(cards));
  if(!q){ document.getElementById('fc-q').value=''; document.getElementById('fc-a').value=''; }
  renderCards(); updateStats();
  if(!q) toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“');
}

async function genAICards(){
  const topic = document.getElementById('aiTopic').value.trim();
  if(!topic){ toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹'); return; }
  loading('aiCardLoading',true);
  try{
    const r = await gemini(`Ø£Ù†Ø´Ø¦ 6 Ø¨Ø·Ø§Ù‚Ø§Øª Ø­ÙØ¸ Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹: "${topic}" Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON ÙÙ‚Ø·:
{"cards":[{"q":"Ø³Ø¤Ø§Ù„","a":"Ø¥Ø¬Ø§Ø¨Ø©"}]}. JSON ÙÙ‚Ø·.`);
    const d = JSON.parse(r.replace(/```json|```/g,'').trim());
    d.cards.forEach(c=>addCard(c.q,c.a,''));
    document.getElementById('aiTopic').value='';
    toast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${d.cards.length} Ø¨Ø·Ø§Ù‚Ø§Øª âœ“`);
  } catch(e){ toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
  finally{ loading('aiCardLoading',false); }
}

function renderCards(){
  const list = document.getElementById('fcList');
  const empty = document.getElementById('fcEmpty');
  document.getElementById('cardCount').textContent = cards.length;
  if(!cards.length){ list.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  list.innerHTML = cards.map((c,i)=>`
    <div class="fcard" onclick="this.classList.toggle('flipped')">
      <button class="fcard-del" onclick="delCard(${i},event)">âœ•</button>
      <div class="fc-q">${c.q}</div>
      <div class="fc-a">${c.a}</div>
      ${c.s&&SC[c.s]?`<div style="font-size:10px;color:var(--muted);margin-top:8px">${SC[c.s].name}</div>`:''}
    </div>`).join('');
}
function delCard(i,e){ e.stopPropagation(); cards.splice(i,1); localStorage.setItem('m_cards',JSON.stringify(cards)); renderCards(); updateStats(); }

function exportCardsPDF(){
  if(!cards.length){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª'); return; }
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18); doc.text('Massar - Flashcards',105,18,{align:'center'});
  let y=32;
  cards.forEach((c,i)=>{
    if(y>260){ doc.addPage(); y=20; }
    doc.setFillColor(20,29,46); doc.roundedRect(12,y,186,24,3,3,'F');
    doc.setFontSize(10); doc.setTextColor(0,229,255);
    const qLines = doc.splitTextToSize(c.q,180); doc.text(qLines,16,y+8);
    doc.setTextColor(150,180,210);
    const aLines = doc.splitTextToSize(c.a,180); doc.text(aLines,16,y+16);
    y+=28;
  });
  doc.save('massar-cards.pdf'); toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ“');
}

// ======================== TASKS ========================
function addTask(){
  const title = document.getElementById('t-title').value.trim();
  if(!title){ toast('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©'); return; }
  tasks.push({ id:Date.now(), title, subject:document.getElementById('t-sub').value,
    date:document.getElementById('t-date').value, priority:document.getElementById('t-pri').value, done:false });
  localStorage.setItem('m_tasks',JSON.stringify(tasks));
  document.getElementById('t-title').value='';
  renderTasks(); updateStats(); toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“');
}

async function genAIPlan(){
  const goal = document.getElementById('planGoal').value.trim();
  if(!goal){ toast('Ø£Ø¯Ø®Ù„ Ù‡Ø¯ÙÙƒ'); return; }
  loading('planLoading',true);
  try{
    const today = new Date().toISOString().split('T')[0];
    const r = await gemini(`Ø£Ù†Ø´Ø¦ Ø®Ø·Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ù„Ù€: "${goal}". Ø§Ù„ÙŠÙˆÙ…: ${today}
5 Ù…Ù‡Ø§Ù… Ù…Ø­Ø¯Ø¯Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON ÙÙ‚Ø·:
{"tasks":[{"title":"Ø¹Ù†ÙˆØ§Ù†","subject":"bio|chem|phys|math|lit|eng","date":"YYYY-MM-DD","priority":"high|med|low"}]}
JSON ÙÙ‚Ø·.`);
    const d = JSON.parse(r.replace(/```json|```/g,'').trim());
    d.tasks.forEach(t=>tasks.push({id:Date.now()+Math.random(),title:t.title,subject:t.subject||'math',date:t.date,priority:t.priority||'med',done:false}));
    localStorage.setItem('m_tasks',JSON.stringify(tasks));
    document.getElementById('planGoal').value='';
    renderTasks(); updateStats(); toast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${d.tasks.length} Ù…Ù‡Ø§Ù… âœ“`);
  } catch(e){ toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
  finally{ loading('planLoading',false); }
}

function renderTasks(){
  const list = document.getElementById('taskList');
  const empty = document.getElementById('taskEmpty');
  document.getElementById('taskCount').textContent = tasks.length;
  if(!tasks.length){ list.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  const pri={'high':'ğŸ”´','med':'ğŸŸ¡','low':'ğŸŸ¢'};
  list.innerHTML = tasks.map((t,i)=>`
    <div class="task-item ${t.done?'done':''}">
      <div class="tchk ${t.done?'done':''}" onclick="toggleTask(${i})">${t.done?'âœ“':''}</div>
      <div style="flex:1">
        <div class="ti-title">${pri[t.priority]||'ğŸŸ¡'} ${t.title}</div>
        <div class="ti-meta">${SC[t.subject]?.name||t.subject} Â· ${t.date}</div>
      </div>
      <span class="ti-del" onclick="delTask(${i})">âœ•</span>
    </div>`).join('');
}
function toggleTask(i){ tasks[i].done=!tasks[i].done; localStorage.setItem('m_tasks',JSON.stringify(tasks)); renderTasks(); updateStats(); }
function delTask(i){ tasks.splice(i,1); localStorage.setItem('m_tasks',JSON.stringify(tasks)); renderTasks(); updateStats(); }

function exportPlanPDF(){
  if(!tasks.length){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…'); return; }
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18); doc.text('Massar - Study Plan',105,18,{align:'center'});
  let y=32;
  tasks.forEach(t=>{
    if(y>270){doc.addPage();y=20;}
    doc.setFontSize(10);
    doc.text(`${t.done?'[âœ“]':'[ ]'} ${t.title} â€” ${t.date}`,14,y); y+=9;
  });
  doc.save('massar-plan.pdf'); toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ“');
}

function exportSubjectPDF(){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  const name = SC[currentSubj]?.name||'Ø§Ù„Ù…Ø§Ø¯Ø©';
  doc.setFontSize(18); doc.text('Massar â€” '+name,105,18,{align:'center'});
  if(currentSubjData){
    const txt = document.getElementById('tab-s').innerText.substring(0,3000);
    const lines = doc.splitTextToSize(txt,180);
    doc.setFontSize(10); doc.text(lines,14,32);
  }
  doc.save('massar-'+currentSubj+'.pdf'); toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ“');
}

async function exportChatPDF(){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18); doc.text('Massar - AI Chat',105,18,{align:'center'});
  let y=32;
  chatHistory.forEach(m=>{
    if(y>270){doc.addPage();y=20;}
    doc.setFontSize(9);
    const role = m.role==='user'?'Ø£Ù†Øª':'AI';
    const txt = m.text.replace(/<[^>]+>/g,' ').substring(0,500);
    const lines = doc.splitTextToSize(role+': '+txt,180);
    doc.text(lines,14,y); y+=lines.length*6+4;
  });
  doc.save('massar-chat.pdf'); toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ“');
}

// ======================== STATS ========================
function updateStats(){
  document.getElementById('st-cards').textContent = cards.length;
  document.getElementById('st-tasks').textContent = tasks.length;
  document.getElementById('st-done').textContent = tasks.filter(t=>t.done).length;
  document.getElementById('st-diags').textContent = diagrams.length;
}

// ======================== UTILS ========================
function loading(id, show){ document.getElementById(id)?.classList[show?'add':'remove']('show'); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600); }

// Drag n Drop
['sp-upload'].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  el.addEventListener('dragover',e=>{e.preventDefault();el.classList.add('over')});
  el.addEventListener('dragleave',()=>el.classList.remove('over'));
  el.addEventListener('drop',e=>{
    e.preventDefault();el.classList.remove('over');
    const f=e.dataTransfer.files[0]; if(!f) return;
    const inp=document.getElementById('sp-file');
    const dt=new DataTransfer(); dt.items.add(f); inp.files=dt.files;
    analyzeSubjectFile(inp);
  });
});
</script>
</body>
</html>
